# =============================================================================
# Novarr Docker Compose - Supervisor Variant
# =============================================================================
# This compose file runs Octane, queue workers, and scheduler in a single
# container using supervisor for process management. This is ideal for
# resource-constrained environments like Unraid with limited container slots.
#
# Usage:
#   docker-compose -f docker-compose.yml -f docker-compose.supervisor.yml up -d
#
# This will:
#   - Disable the separate scheduler and worker services
#   - Add an app-supervisor service that runs everything
# =============================================================================

version: '3.8'

services:
  # Disable separate scheduler service when using supervisor variant
  scheduler:
    profiles:
      - disabled

  # Disable separate worker service when using supervisor variant
  worker:
    profiles:
      - disabled

  # Combined app with supervisor managing Octane, workers, and scheduler
  app-supervisor:
    image: ${NOVARR_IMAGE:-novarr}:${NOVARR_TAG:-latest}
    container_name: novarr-app-supervisor
    restart: unless-stopped
    user: root
    entrypoint: ["/docker/entrypoint-supervisor.sh"]
    command: []
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=novarr
      - DB_USERNAME=novarr_user
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - REDIS_CLIENT=phpredis
      - REDIS_CACHE_DB=1
      - REDIS_SESSION_DB=2
      - CACHE_STORE=redis
      - SESSION_DRIVER=redis
      - QUEUE_CONNECTION=redis
      - OCTANE_SERVER=roadrunner
      - SUPERVISOR_WORKER_PROCESSES=${SUPERVISOR_WORKER_PROCESSES:-2}
    volumes:
      - ./storage:/var/www/html/storage
      - ./storage/app:/var/www/html/storage/app
      - ./storage/framework:/var/www/html/storage/framework
      - ./storage/logs:/var/www/html/storage/logs
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
      - ./public/storage:/var/www/html/public/storage
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - novarr-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
