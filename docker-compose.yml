version: '3.8'

services:
  app:
    image: ${NOVARR_IMAGE:-novarr}:${NOVARR_TAG:-latest}
    container_name: novarr-app
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 10s
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=novarr
      - DB_USERNAME=novarr_user
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
      - QUEUE_CONNECTION=redis
      - OCTANE_SERVER=roadrunner
    volumes:
      - ./storage:/var/www/html/storage
      - ./storage/app:/var/www/html/storage/app
      - ./storage/framework:/var/www/html/storage/framework
      - ./storage/logs:/var/www/html/storage/logs
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
      - ./public/storage:/var/www/html/public/storage
      - ./public/vendor:/var/www/html/public/vendor
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - novarr-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  mysql:
    image: mysql:8.0
    container_name: novarr-mysql
    restart: unless-stopped
    environment:
      - MYSQL_DATABASE=novarr
      - MYSQL_USER=novarr_user
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - "3306:3306"
    networks:
      - novarr-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: novarr-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - novarr-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  nginx:
    image: nginx:alpine
    container_name: novarr-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/upstream.conf:/etc/nginx/conf.d/upstream.conf:ro
      - ./public:/var/www/html/public:ro
      - ./public/vendor:/var/www/html/public/vendor:ro
      - ./storage/app/public:/var/www/html/storage/app/public:ro
    networks:
      - novarr-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  scheduler:
    image: ${NOVARR_IMAGE:-novarr}:${NOVARR_TAG:-latest}
    container_name: novarr-scheduler
    restart: unless-stopped
    command: ["php", "artisan", "schedule:work"]
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=novarr
      - DB_USERNAME=novarr_user
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - CACHE_DRIVER=redis
      - QUEUE_CONNECTION=redis
    volumes:
      - ./storage:/var/www/html/storage
      - ./storage/app:/var/www/html/storage/app
      - ./storage/framework:/var/www/html/storage/framework
      - ./storage/logs:/var/www/html/storage/logs
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - novarr-network

  worker:
    image: ${NOVARR_IMAGE:-novarr}:${NOVARR_TAG:-latest}
    container_name: novarr-worker
    restart: unless-stopped
    command: ["php", "artisan", "queue:work", "redis", "--queue=commands,default", "--sleep=3", "--tries=3", "--max-time=3600"]
    environment:
      - APP_ENV=production
      - APP_DEBUG=false
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_DATABASE=novarr
      - DB_USERNAME=novarr_user
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_HOST=redis
      - CACHE_DRIVER=redis
      - QUEUE_CONNECTION=redis
    volumes:
      - ./storage:/var/www/html/storage
      - ./storage/app:/var/www/html/storage/app
      - ./storage/framework:/var/www/html/storage/framework
      - ./storage/logs:/var/www/html/storage/logs
      - ./bootstrap/cache:/var/www/html/bootstrap/cache
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - novarr-network
    healthcheck:
      test: ["CMD", "php", "artisan", "queue:health-check"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  novarr-network:
    driver: bridge

volumes:
  mysql-data:
  redis-data:
